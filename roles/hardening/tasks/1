---
# 1. Disable root login via SSH
- name: Disable root login via SSH
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PermitRootLogin'
    line: 'PermitRootLogin no'
    state: present
  notify: restart ssh

# 2. Force SSH Protocol 2
- name: Force SSH Protocol 2
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?Protocol'
    line: 'Protocol 2'
    state: present
  notify: restart ssh

# 3. Set minimum password length
- name: Set minimum password length
  lineinfile:
    path: /etc/security/pwquality.conf
    regexp: '^#?minlen'
    line: 'minlen = 8'
    state: present

# 4. Set password expiry to 90 days
- name: Set password expiry to 90 days
  lineinfile:
    path: /etc/login.defs
    regexp: '^PASS_MAX_DAYS'
    line: 'PASS_MAX_DAYS   90'
    state: present

# 5. Set shell idle timeout
- name: Set shell idle timeout
  lineinfile:
    path: /etc/profile
    regexp: '^TMOUT='
    line: 'TMOUT=600'
    state: present

- name: Export TMOUT
  lineinfile:
    path: /etc/profile
    line: 'export TMOUT'
    insertafter: '^TMOUT='
    state: present

# 6. Enable firewalld
- name: Enable and start firewalld
  systemd:
    name: firewalld
    state: started
    enabled: yes

# 7. Allow SSH only
- name: Allow SSH only
  firewalld:
    service: ssh
    permanent: yes
    state: enabled
    immediate: yes

# 8. Enable SELinux enforcing
- name: Enable SELinux enforcing
  selinux:
    policy: targeted
    state: enforcing

# 9. Check unnecessary services existence (NO FAIL)
- name: Check unnecessary services existence
  command: systemctl list-unit-files {{ item }}.service
  register: svc_check
  failed_when: false
  changed_when: false
  loop:
    - avahi-daemon
    - cups
    - telnet
    - ftp

# 10. Disable unnecessary services (ONLY IF EXISTS)
- name: Disable unnecessary services if exists
  service:
    name: "{{ item.item }}"
    state: stopped
    enabled: no
  when: "'{{ item.item }}.service' in item.stdout"
  loop: "{{ svc_check.results }}"

# 11. Copy legal login banner
- name: Copy legal login banner
  copy:
    src: issue.net
    dest: /etc/issue.net
    owner: root
    group: root
    mode: '0644'

- name: Enable banner in sshd
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?Banner'
    line: 'Banner /etc/issue.net'
    state: present
  notify: restart ssh

