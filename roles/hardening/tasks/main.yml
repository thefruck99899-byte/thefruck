---
# =========================
# SSH HARDENING
# =========================

- name: Disable root login via SSH
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PermitRootLogin'
    line: 'PermitRootLogin no'
    state: present
    backup: yes
  notify: Restart sshd

- name: Force SSH Protocol 2
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?Protocol'
    line: 'Protocol 2'
    state: present
    backup: yes
  notify: Restart sshd

- name: Set SSH banner file
  copy:
    src: issue.net
    dest: /etc/issue.net
    owner: root
    group: root
    mode: '0644'
  notify: Restart sshd

- name: Enable SSH banner
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?Banner'
    line: 'Banner /etc/issue.net'
    state: present
    backup: yes
  notify: Restart sshd

# =========================
# PASSWORD POLICY
# =========================

- name: Set minimum password length
  lineinfile:
    path: /etc/security/pwquality.conf
    regexp: '^#?minlen'
    line: 'minlen = 12'
    state: present
    backup: yes

- name: Set password expiry to 90 days
  lineinfile:
    path: /etc/login.defs
    regexp: '^PASS_MAX_DAYS'
    line: 'PASS_MAX_DAYS   90'
    state: present
    backup: yes

# =========================
# SESSION TIMEOUT
# =========================

- name: Set shell idle timeout
  lineinfile:
    path: /etc/profile
    regexp: '^TMOUT='
    line: 'TMOUT=900'
    state: present
    backup: yes

- name: Export TMOUT
  lineinfile:
    path: /etc/profile
    regexp: '^export TMOUT'
    line: 'export TMOUT'
    state: present

# =========================
# FIREWALL & SELINUX
# =========================

- name: Enable and start firewalld
  service:
    name: firewalld
    state: started
    enabled: yes

- name: Allow SSH service only
  firewalld:
    service: ssh
    permanent: yes
    state: enabled
    immediate: yes

- name: Enable SELinux enforcing
  selinux:
    policy: targeted
    state: enforcing

# =========================
# DISABLE UNUSED SERVICES (SAFE MODE)
# =========================

- name: Stop and disable avahi-daemon if exists
  service:
    name: avahi-daemon
    state: stopped
    enabled: no
  ignore_errors: yes

- name: Stop and disable cups if exists
  service:
    name: cups
    state: stopped
    enabled: no
  ignore_errors: yes

- name: Stop and disable telnet if exists
  service:
    name: telnet
    state: stopped
    enabled: no
  ignore_errors: yes

- name: Stop and disable ftp if exists
  service:
    name: vsftpd
    state: stopped
    enabled: no
  ignore_errors: yes

